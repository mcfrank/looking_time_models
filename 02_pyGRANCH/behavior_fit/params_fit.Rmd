

```{r}
library(tidyverse)
library(here)
library(ggthemes)

source(here("behavior_fit/helper/fitting.r"))
source(here("behavior_fit/helper/scaling.r"))
```

# Randomly select 100 human subjects

```{r}
subject <- read_csv(here("behavior_fit/data/raw_data/cogsci_all.csv")) %>% 
  distinct(subject) %>% 
  pull()

train_subject <- sample(subject, 0.1 * (length(subject)))


raw_data <- read_csv(here("behavior_fit/data/raw_data/cogsci_all.csv")) 

tidy_data <- raw_data %>% 
  mutate(
    stimuli_sequence = case_when(
      deviant_position == 2 ~ "BDBBBB", 
      deviant_position == 4 ~ "BBBDBB", 
      deviant_position == 6 ~ "BBBBBD", 
      is.na(deviant_position) ~ "BBBBBB"
    ), 
    complexity = case_when(
      grepl("complex", block_type) ~ "complex", 
      grepl("simple", block_type) ~ "simple"
    )
  ) %>% 
  select(subject, trial_number, trial_type, stimuli_sequence, complexity, trial_looking_time) 




train_d <-  tidy_data %>% 
  filter(subject %in% train_subject)

test_d <-  tidy_data  %>% 
  filter(!subject %in% train_subject)

write_csv(train_d, here("behavior_fit/data/processed_data/train_d.csv"))
write_csv(test_d, here("behavior_fit/data/processed_data/test_d.csv"))
```

# Select param 


## cleaning behavioral data 

```{r}
train_d <- read_csv(here("behavior_fit/data/processed_data/train_d.csv"))

summary_train_d <- train_d %>% 
  group_by(stimuli_sequence, trial_number, trial_type) %>% 
  summarise(mean_lt = mean(trial_looking_time))
```

## preprocessing of the simulation res 

```{r}
raw_sim <- read_csv(here("behavior_fit/data/raw_data/summarized_results_detailed_spore_adult.csv"), col_names = FALSE)
```
```{r}
colnames(raw_sim) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "n_samples")

summarised_sample <- raw_sim %>% 
  # param info needs to fixed 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  group_by(param_info, stim_sequence, trial_num) %>% 
  summarise(mean_sample = mean(n_samples)) %>% 
  mutate(trial_num = trial_num + 1) %>% 
  rename(trial_number = trial_num, 
         stimuli_sequence = stim_sequence)

```


## putting things together 

```{r}
all_sim_d <- summary_train_d %>% 
  left_join(summarised_sample, BY = c("stimuli_sequence", "trial_number")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)
```

## fitting 


```{r}
fitting_res <- get_fitting_stats(all_sim_d)
saveRDS(fitting_res, here("behavior_fit/cached_res/train_fit.RDS"))
```




```{r}
test_d <- read_csv(here("behavior_fit/data/processed_data/test_d.csv"))

summary_test_d <- test_d %>% 
  group_by(stimuli_sequence, trial_number, trial_type) %>% 
  summarise(mean_lt = mean(trial_looking_time))

all_test_d <- summary_test_d %>% 
  left_join(summarised_sample, BY = c("stimuli_sequence", "trial_number")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)

fitting_test_res <- get_fitting_stats(all_test_d)
saveRDS(fitting_test_res, here("behavior_fit/cached_res/test_fit.RDS"))
```




# scaling

```{r}
scaling_param <- get_scaling_param(all_sim_d)
saveRDS(scaling_param, here("behavior_fit/cached_res/scaling.RDS"))


fitting_test_res %>% 
  filter(param_info == (fitting_res %>% arrange(-r) %>% head(1))$param_info) %>% 
  left_join(scaling_param %>% select(-data), by = c("param_info")) %>% 
  unnest(data) %>% 
   mutate(
    scaled_sample = (mean_sample - intercept) / coef
  ) %>% 
  pivot_longer(cols  = c("scaled_sample", "mean_lt"), values_to = "val", names_to = "val_type") %>% 
  ggplot(aes(x = trial_number, y = val, color = val_type)) + 
  geom_point() + 
  theme_few() + 
  facet_wrap(~stimuli_sequence) + 
  theme_few()
```

## get error bar 

```{r}
scaling_key <- fitting_test_res %>% 
  filter(param_info == (fitting_res %>% arrange(-r) %>% head(1))$param_info) %>% 
  left_join(scaling_param %>% select(-data), by = c("param_info")) %>% 
  select(param_info, intercept, coef)

best_fitting_raw <- raw_sim %>% 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  filter(param_info == scaling_key$param_info)

best_fitting_scaled <- best_fitting_raw %>% 
  mutate(scaled_sample = (n_samples - scaling_key$intercept) / scaling_key$coef)

best_fitting_scaled %>% 
  ggplot(aes(x = trial_num, y = scaled_sample)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~stim_sequence) + theme_few()
```




```{r}
fit_d <- fitting_res %>% filter(param_info == "mu_0_v_1_a_1_b_1_ep_0.001") %>% 
  unnest(data) %>% 
  ungroup()

# mean_sample = b + a * mean_lt 
# scaled_mean_sample = (mean_sample - b) / a 

fit_res <- lm(mean_sample~ mean_lt, d = fit_d) %>% broom::tidy()
intercept = filter(fit_res, term == "(Intercept)")$estimate
coef = filter(fit_res, term == "mean_lt")$estimate

scaled_d <- fit_d %>% 
  mutate(
    scaled_sample = (mean_sample - intercept) / coef
  )

scaled_d %>% 
  pivot_longer(cols = c("mean_lt", "scaled_sample"), 
               names_to = "type", 
               values_to = "val") %>% 
  ggplot(aes(x = trial_number, y = val, color = type)) + 
  geom_point() +
  facet_wrap(~stimuli_sequence) + 
  theme_few()
```



# Complexity


```{r}
cd <- read_csv(here("behavior_fit/data/raw_data/sim_with_complexity.csv"), 
               col_names = FALSE)

colnames(cd) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "complexity", "n_samples")

summarised_cd <- cd %>% 
  # param info needs to fixed 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  group_by(param_info, stim_sequence, complexity, trial_num) %>% 
  summarise(mean_sample = mean(n_samples)) %>% 
  mutate(trial_num = trial_num + 1) %>% 
  rename(trial_number = trial_num, 
         stimuli_sequence = stim_sequence)

```



```{r}
summary_train_cd <- train_d %>% 
  group_by(stimuli_sequence, trial_number, trial_type, complexity) %>% 
  summarise(mean_lt = mean(trial_looking_time))
```


```{r}
all_sim_cd <- summary_train_cd %>% 
  left_join(summarised_cd, by = c("stimuli_sequence", "trial_number", "complexity")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)

fitting_c_res <- get_fitting_stats(all_sim_cd)
saveRDS(fitting_c_res, here("behavior_fit/cached_res/train_by_complexity_fit.RDS"))

summary_test_cd <- test_d %>% 
  group_by(stimuli_sequence, trial_number, trial_type, complexity) %>% 
  summarise(mean_lt = mean(trial_looking_time))

all_test_cd <- summary_test_cd %>% 
  left_join(summarised_cd, by = c("stimuli_sequence", "trial_number", "complexity")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)

fitting_test_c_res <- get_fitting_stats(all_test_cd)
saveRDS(fitting_test_c_res, here("behavior_fit/cached_res/test_by_complexity_fit.RDS"))


```

```{r}
fitting_c_res %>% 
  arrange(-r)

fitting_test_c_res %>% 
  arrange(-r)
```


```{r}
scaling_c_param <- get_scaling_param(all_sim_cd)
saveRDS(scaling_c_param, here("behavior_fit/cached_res/scaling_by_complexity.RDS"))

fitting_test_c_res %>% 
  filter(param_info == (fitting_c_res %>% arrange(-r) %>% head(1))$param_info) %>% 
  left_join(scaling_c_param %>% select(-data), by = c("param_info")) %>% 
  unnest(data) %>% 
   mutate(
    scaled_sample = (mean_sample - intercept) / coef
  ) %>% 
  pivot_longer(cols  = c("scaled_sample", "mean_lt"), values_to = "val", names_to = "val_type") %>% 
  ggplot(aes(x = trial_number, y = val, color = complexity))+ 
  geom_point() + 
  #geom_line() + 
  theme_few() + 
  #facet_wrap(~stimuli_sequence) + 
  facet_grid(stimuli_sequence~val_type) + 
  theme_few() 


```



```{r}
fitting_res %>% arrange(rmse)
```


# No noise 

```{r}
nn <- read_csv(here("behavior_fit/data/raw_data/no_noise.csv"), 
               col_names = FALSE)

colnames(nn) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior",  "n_samples")

summarised_nn <- nn %>% 
  # param info needs to fixed 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  group_by(param_info, stim_sequence, trial_num) %>% 
  summarise(mean_sample = mean(n_samples)) %>% 
  mutate(trial_num = trial_num + 1) %>% 
  rename(trial_number = trial_num, 
         stimuli_sequence = stim_sequence)

nn_test_d <- summary_test_d %>% 
  left_join(summarised_nn, by = c("stimuli_sequence", "trial_number")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)

fitting_nn_res <- get_fitting_stats(nn_test_d)
#saveRDS(fitting_test_c_res, here("behavior_fit/cached_res/test_by_complexity_fit.RDS"))
```

```{r}
scale_key <- readRDS(here("behavior_fit/cached_res/scaling.RDS"))
intercept = -10.3
coef = 0.00601

nn %>% 
   mutate(
    scaled_sample = (n_samples - intercept) / coef
  ) %>% 
  ggplot(aes(x = trial_num, y = scaled_sample)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~stim_sequence)
```


# No learning 
```{r}
nl <- read_csv(here("behavior_fit/data/raw_data/no_learning.csv"), 
               col_names = FALSE)

colnames(nl) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior",  "n_samples")

summarised_nl <- nl %>% 
  # param info needs to fixed 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  group_by(param_info, stim_sequence, trial_num) %>% 
  summarise(mean_sample = mean(n_samples)) %>% 
  mutate(trial_num = trial_num + 1) %>% 
  rename(trial_number = trial_num, 
         stimuli_sequence = stim_sequence)

nl_test_d <- summary_test_d %>% 
  left_join(summarised_nl, by = c("stimuli_sequence", "trial_number")) %>% 
  ungroup() %>% 
  group_by(param_info) %>% 
  nest(data = -param_info)

nl_res <- get_fitting_stats(nl_test_d)
saveRDS(nl_res, here("behavior_fit/cached_res/nl_test_fit.RDS"))

```


```{r}
nn %>% 
  ggplot(aes(x = trial_num, y = n_samples)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~stim_sequence)

nl %>% 
  ggplot(aes(x = trial_num, y = n_samples)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~stim_sequence)
```




# ARCHIVE



```{r}
all_model_sim_res <- model_d %>% 
  group_by(mu_prior, v_prior, alpha_prior, beta_prior, epsilon, world_EIG, stim_sequence) %>% 
   summarise(across(c("stim1", "stim2", "stim3", "stim4", "stim5", "stim6"), ~ mean(.x, na.rm = TRUE))) %>% 
   pivot_longer(
    cols = c("stim1", "stim2", "stim3", "stim4", "stim5", "stim6"), 
    values_to = "sample_n", 
    names_to = "trial_number"
  ) %>% 
  mutate(
    param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, "eig", world_EIG, sep = "_"), 
    trial_number = case_when(
      trial_number == "stim1" ~ 1, 
      trial_number == "stim2" ~ 2, 
      trial_number == "stim3" ~ 3, 
      trial_number == "stim4" ~ 4, 
      trial_number == "stim5" ~ 5, 
      trial_number == "stim6" ~ 6
    )
  ) %>% 
  ungroup() %>% 
  select(stim_sequence, trial_number, sample_n, param_info)
  
```

## preprocessing small simulation results 

```{r}
small_simulation <- read_csv(here("data/summary_small_sim.csv")) %>% 
  mutate(
    param_info = weig, 
    stim_sequence = stimuli, 
    trial_number = stimulus_id + 1, 
    sample_n = mean_sample_n
  ) %>% 
  select(stim_sequence, trial_number, sample_n, param_info)

```


## chopping the stimuli sequence 

```{r}
get_exact_sequence <- function(all_model_sim_res, seq_type){
  
  if(seq_type == "BB" | seq_type == "BBBB" | seq_type == "BBBBBB"){
    
    df <- all_model_sim_res %>% 
      filter(stim_sequence == "BBBBBB") %>% 
      filter(trial_number <= nchar(seq_type)) %>% 
      mutate(stim_sequence = seq_type)
    
  }else if(seq_type == "BD"){
    
    df <- all_model_sim_res %>% 
      filter(stim_sequence == "BDBBBB") %>% 
      filter(trial_number <= nchar(seq_type)) %>% 
      mutate(stim_sequence = seq_type)
    
  }else if(seq_type == "BBBD"){
    
    df <- all_model_sim_res %>% 
      filter(stim_sequence == "BBBDBB") %>% 
      filter(trial_number <= nchar(seq_type)) %>% 
      mutate(stim_sequence = seq_type)
    
  }else if(seq_type == "BBBBBD"){
    
    df <- all_model_sim_res %>% 
      filter(stim_sequence == "BBBBBD") 
  }
  
  return (df) 
  
}
```



```{r}
chopped_sim_res <- lapply(
  c("BB", "BD", "BBBB", "BBBD", "BBBBBB", "BBBBBD"), 
  function(x){
    get_exact_sequence(small_simulation, x)
  }
) %>% 
  bind_rows()

```


```{r}
complete_sim_res <- all_model_sim_res %>% 
  group_by(param_info) %>% 
  count() %>% 
  filter(n == 24)

chopped_sim_res <- lapply(
  c("BB", "BD", "BBBB", "BBBD", "BBBBBB", "BBBBBD"), 
  function(x){
    get_exact_sequence(all_model_sim_res %>% filter(param_info %in% complete_sim_res$param_info), x)
  }
) %>% 
  bind_rows()
```


```{r}
edited_sim_res <- chopped_sim_res %>% 
  mutate(
    edited_sample_n = case_when(
      trial_number == 1 ~ sample_n, 
      TRUE ~ sample_n + 1
    )
  )
```


# find correlation

    

```{r}
tidy_train_summary_d <- tidy_train_d %>% 
  group_by(trial_number, trial_type, stimuli_sequence) %>% 
  summarise(total_rt = mean(total_rt))

scaled_sim_res <- chopped_sim_res %>% 
  rename(stimuli_sequence = stim_sequence) %>% 
  left_join(tidy_train_summary_d, by = c("trial_number", "stimuli_sequence")) %>% 
  group_by(param_info) %>% 
  summarise(
    mean_sim = mean((sample_n), na.rm = TRUE), 
    sd_sim = sd((sample_n), na.rm = TRUE), 
    mean_rt = mean((total_rt), na.rm = TRUE), 
    sd_rt = sd((total_rt), na.rm = TRUE)
  ) %>% 
  left_join(chopped_sim_res %>% rename(stimuli_sequence = stim_sequence), by = "param_info") %>% 
  left_join(tidy_train_summary_d, by = c("trial_number", "stimuli_sequence")) %>% 
  mutate(
    multiply_const = sd_rt /sd_sim
  ) %>% 
  mutate(
    scaled_stim_sample_n = mean_rt + (sample_n - mean_sim) * multiply_const
  ) %>% 
  select(param_info, stimuli_sequence, trial_number, scaled_stim_sample_n,total_rt) %>% 
  group_by(param_info) %>% 
  nest()
```




```{r}
scaled_sim_res %>% 
  #filter(param_info %in% c("mu_0_v_1_a_10_b_35_ep_1e-04_eig_1")) %>% 
  unnest(data) %>% 
  mutate(total_rt = (total_rt)) %>% 
  pivot_longer(cols = c("scaled_stim_sample_n", "total_rt"), 
               names_to = "value_type", 
               values_to = "value") %>% 
  ggplot(aes(x = trial_number, y = value, color = value_type, group = value_type)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  #scale_y_log10()+
  
  facet_grid(param_info ~ stimuli_sequence)
```

```{r}
 rmse_interval <- function(rmse, deg_free, p_lower = 0.025, p_upper = 0.975){
    tibble(.pred_lower = sqrt(deg_free / qchisq(p_upper, df = deg_free)) * rmse,
           .pred_upper = sqrt(deg_free / qchisq(p_lower, df = deg_free)) * rmse)
  }
  
```


```{r}
scaled_sim_res$r <- unlist(map(scaled_sim_res$data, function(x){
    r <- cor(x$total_rt, x$scaled_stim_sample_n, method = "pearson")
  }))



# scaled_sim_res$r_ci <- unlist(map(scaled_sim_res$data, function(x){
#    r_conf <- confintr::ci_cor(x$total_rt, x$sample_n, method = "pearson", type = "bootstrap")["interval"][[1]]
#    r_conf_print <- paste0("[", round(r_conf[1],2), ", ", round(r_conf[2],2), "]")
#    return(r_conf_print)
#  }))
 
scaled_sim_res$rmse <- unlist(map(scaled_sim_res$data, function(x){
    rmse_log <- Metrics::rmse(x$total_rt, x$sample_n)
  }))
  
scaled_sim_res$rmse_ci <- unlist(map(scaled_sim_res$data, function(x){
    rmse <- Metrics::rmse(x$total_rt, x$sample_n)
    rmse_interval <- rmse_interval(rmse, nrow(x))
    rmse_conf_print <- paste0("[", round(rmse_interval$.pred_lower,2), ", ", 
                              round(rmse_interval$.pred_upper,2), "]")
  }))
    
    
scaled_sim_res %>% 
  ggplot(aes(x = r)) + 
  geom_histogram()
```

```{r}
scaled_sim_res %>% 
  arrange(-r) %>% 
  ggplot(aes(x = r)) + 
  geom_histogram(bins = 40)
```

## plotting 

```{r}
scaled_sim_res %>% 
  arrange(-r) %>% 
  head(1) %>% 
  unnest(data) %>% 
  pivot_longer(cols = c("scaled_stim_sample_n", "total_rt"), 
               names_to = "value_type", 
               values_to = "value") %>% 
  ggplot(aes(x = trial_number, y = value, color = value_type, group = value_type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .4)) +
  #scale_y_log10()+
  
  facet_wrap( ~ stimuli_sequence) +
  theme_few()
```



```{r}
tidy_train_d %>% 
  ggplot(aes(x = trial_number, y = total_rt)) + 
  #geom_point(alpha = .2, position = position_jitter(width = .2))+
  stat_summary(fun.data = "mean_cl_boot") + 
  facet_wrap(~stimuli_sequence)


tidy_train_d %>% 
  group_by(stimuli_sequence) %>% 
  count()
```





```{r}
scaled_sim_res %>% 
   separate(param_info, into = c("mu", "mu_val", "v", "v_val", "a", "a_val", "b", "b_val", "ep", "ep_val", "eig", "eig_val"), 
           sep = "_") %>% 
  ggplot(aes(x = mu_val, y = r, color = eig_val)) + 
  geom_point()+
  facet_grid(b_val~a_val) + 
  theme_few()


scaled_sim_res %>% 
  separate(param_info, into = c("mu", "mu_val", "v", "v_val", "a", "a_val", "b", "b_val", "ep", "ep_val", "eig", "eig_val"), 
           sep = "_") %>% 
  ggplot(aes(x = eig_val, y = r, color = ep_val)) + 
  geom_point() + 
  theme_few() +
  facet_wrap(a_val ~ b_val)
```


# compare behavioral dataset

```{r}


cogsci_data <- read_csv(here("data/cogsci_data.csv"))

cs_data <- cogsci_data %>% 
  mutate(stimuli_sequence = case_when(
    deviant_position == 2 ~ "BDBBBB", 
    deviant_position == 4 ~ "BBBDBB", 
    deviant_position == 6 ~ "BBBBBD", 
    is.na(deviant_position) ~ "BBBBBB"
  )) %>% 
  select(stimuli_sequence, subject, trial_looking_time, trial_type, trial_number) %>% 
  rename(total_rt = trial_looking_time) %>% 
  mutate(dataset = "cogsci") %>% 
  filter(
    (stimuli_sequence == "BDBBBB" & trial_number < 3) | 
    (stimuli_sequence == "BBBDBB" & trial_number < 5) | 
      stimuli_sequence == "BBBBBB" | stimuli_sequence == "BBBBBD"
  ) %>% 
  mutate(stimuli_sequence = case_when(
      stimuli_sequence == "BDBBBB" ~ "BD", 
    stimuli_sequence == "BBBDBB" ~ "BBBD", 
    TRUE ~ stimuli_sequence
  )) %>% 
  filter(!(stimuli_sequence %in% c("BB", "BBBB")))

combined_data <- bind_rows(tidy_train_d %>% mutate(dataset = "recent"), cs_data) %>% 
  filter(!(stimuli_sequence %in% c("BB", "BBBB")))
```

```{r}
combined_data %>% 
  ggplot(aes(x = trial_number, y = total_rt, color = dataset)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  facet_wrap(~stimuli_sequence) + 
  theme_few()
```

# fit small simulation w/ original results 

```{r}
clean_cogsci <- cs_data <- cogsci_data %>% 
  mutate(stimuli_sequence = case_when(
    deviant_position == 2 ~ "BDBBBB", 
    deviant_position == 4 ~ "BBBDBB", 
    deviant_position == 6 ~ "BBBBBD", 
    is.na(deviant_position) ~ "BBBBBB"
  )) %>% 
  select(stimuli_sequence, subject, trial_looking_time, trial_type, trial_number) %>% 
  rename(total_rt = trial_looking_time) 
 

summary_cogsci <- clean_cogsci %>% 
  group_by(stimuli_sequence, trial_type, trial_number) %>% 
  summarise(total_rt = mean(total_rt))

small_simulation <- read_csv(here("data/summary_small_sim.csv")) %>% 
  mutate(
    param_info = weig, 
    stim_sequence = stimuli, 
    trial_number = stimulus_id + 1, 
    sample_n = mean_sample_n
  ) %>% 
  select(stim_sequence, trial_number, sample_n, param_info)


#small_simulation <- small_simulation %>% 
#  mutate(sample_n = sample_n + 6)


scaled_sim_res <- small_simulation  %>% 
  rename(stimuli_sequence = stim_sequence) %>% 
  left_join(summary_cogsci, by = c("trial_number", "stimuli_sequence")) %>% 
  group_by(param_info) %>% 
  summarise(
    mean_sim = mean((sample_n), na.rm = TRUE), 
    sd_sim = sd((sample_n), na.rm = TRUE), 
    mean_rt = mean((total_rt), na.rm = TRUE), 
    sd_rt = sd((total_rt), na.rm = TRUE)
  ) %>% 
  left_join(small_simulation %>% rename(stimuli_sequence = stim_sequence), by = "param_info") %>% 
  left_join(summary_cogsci, by = c("trial_number", "stimuli_sequence")) %>% 
  mutate(
    multiply_const = sd_rt /sd_sim
  ) %>% 
  mutate(
    scaled_stim_sample_n = mean_rt + (sample_n - mean_sim) * multiply_const
  ) %>% 
  select(param_info, stimuli_sequence, trial_number, sample_n, scaled_stim_sample_n,total_rt) %>% 
  group_by(param_info) %>% 
  nest()

scaled_sim_res$r <- unlist(map(scaled_sim_res$data, function(x){
    r <- cor(x$total_rt, x$sample_n, method = "pearson")
  }))

scaled_sim_res
```


# fit large simulation with cogsci

```{r}


summary_cogsci <- clean_cogsci %>% 
  group_by(stimuli_sequence, trial_type, trial_number) %>% 
  summarise(total_rt = mean(total_rt))

#small_simulation <- small_simulation %>% 
#  mutate(sample_n = sample_n + 6)


scaled_sim_res <- all_model_sim_res  %>% 
  rename(stimuli_sequence = stim_sequence) %>% 
  left_join(summary_cogsci, by = c("trial_number", "stimuli_sequence")) %>% 
  group_by(param_info) %>% 
  summarise(
    mean_sim = mean((sample_n), na.rm = TRUE), 
    sd_sim = sd((sample_n), na.rm = TRUE), 
    mean_rt = mean((total_rt), na.rm = TRUE), 
    sd_rt = sd((total_rt), na.rm = TRUE)
  ) %>% 
  left_join(all_model_sim_res %>% rename(stimuli_sequence = stim_sequence), by = "param_info") %>% 
  left_join(summary_cogsci, by = c("trial_number", "stimuli_sequence")) %>% 
  mutate(
    multiply_const = sd_rt /sd_sim
  ) %>% 
  mutate(
    scaled_stim_sample_n = mean_rt + (sample_n - mean_sim) * multiply_const
  ) %>% 
  select(param_info, stimuli_sequence, trial_number, sample_n, scaled_stim_sample_n,total_rt) %>% 
  group_by(param_info) %>% 
  nest()

scaled_sim_res$r <- unlist(map(scaled_sim_res$data, function(x){
    r <- cor(x$total_rt, x$sample_n, method = "pearson")
  }))

cogsci_fit <- scaled_sim_res %>% 
  arrange(-r) %>% 
  mutate(fit_type = "cogsci")



```


```{r}
newdata_fit <- scaled_sim_res %>% 
  mutate(fit_type = "new_data")
```


```{r}
bind_rows(cogsci_fit, newdata_fit) %>% 
  ggplot(aes(x = fit_type, y = r, group = param_info)) + 
  geom_point(alpha = .2, position = position_dodge(width = .2)) + 
  geom_line(position = position_dodge(width = .2), alpha = .2) + 
  theme_few()
```

