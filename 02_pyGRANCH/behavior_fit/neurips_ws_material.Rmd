
```{r}
library(tidyverse)
library(here)


```

```{r}
train_d <- read_csv(here("behavior_fit/data/processed_data/train_d.csv"))
test_d <- read_csv(here("behavior_fit/data/processed_data/test_d.csv"))

train_sum_d <- train_d %>% 
  group_by(trial_number, stimuli_sequence) %>% 
  summarise(train_mean_lt = mean(trial_looking_time))

test_sum_d <- test_d %>% 
  group_by(trial_number, stimuli_sequence) %>% 
  summarise(test_mean_lt = mean(trial_looking_time))


total_d <- test_sum_d %>% 
  left_join(train_sum_d, by = c("trial_number", "stimuli_sequence"))

r <- cor(total_d$test_mean_lt, total_d$train_mean_lt, method = "pearson")
```



```{r}
test_d %>% 
  select(trial_number, stimuli_sequence, trial_looking_time) %
```

```{r}
raw_d <- read_csv(here("behavior_fit/data/raw_data/summarized_results_detailed_spore_adult.csv"))
colnames(raw_d) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "n_samples")
scaling_df <- readRDS(here("behavior_fit/cached_res/scaling.RDS")) %>% 
  filter(param_info == readRDS(here("behavior_fit/cached_res/train_fit.RDS")) %>% arrange(-r) %>% head(1) %>% pull(param_info))



best_fitting_raw <- raw_d %>% 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  filter(param_info == scaling_df$param_info)

best_fitting_scaled <- best_fitting_raw %>% 
  mutate(scaled_sample = (n_samples - scaling_df$intercept) / scaling_df$coef)
```


# Complexity stats 

```{r}
library(lme4)
library(lmerTest)
test_d <- read_csv(here("behavior_fit/data/processed_data/test_d.csv"))


#m0 <- lmer(log(trial_looking_time) ~ I((exp(1)**(-trial_number))) * trial_type * complexity + (trial_number * trial_type * complexity|subject), 
 #    data = test_d)

#m1 <- lmer(log(trial_looking_time) ~ I((exp(1)**(-trial_number))) * trial_type * complexity + (trial_number * complexity|subject), 
#     data = test_d)

m2 <- lmer(log(trial_looking_time) ~ I((exp(1)**(-trial_number))) * trial_type * complexity + (complexity|subject), 
     data = test_d)

behavioral_model_summary <- summary(m2)$coefficients %>% as.data.frame() 




```


```{r}
raw_cd <- read_csv(here("behavior_fit/data/raw_data/sim_with_complexity.csv"))
colnames(raw_cd) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "complexity", "n_samples")
scaling_df <- readRDS(here("behavior_fit/cached_res/scaling.RDS")) %>% 
  filter(param_info == readRDS(here("behavior_fit/cached_res/train_fit.RDS")) %>% arrange(-r) %>% head(1) %>% pull(param_info))



best_fitting_cd<- raw_cd %>% 
  mutate( param_info = paste("mu", mu_prior, "v", v_prior, "a", alpha_prior, "b", beta_prior, "ep", epsilon, sep = "_")) %>% 
  filter(param_info == scaling_df$param_info)

best_fitting_scaled_cd <- best_fitting_cd %>% 
  mutate(scaled_sample = (n_samples - scaling_df$intercept) / scaling_df$coef)

```


```{r}
best_fitting_scaled_cd <- best_fitting_scaled_cd %>% 
  mutate(trial_number = trial_num + 1, 
         trial_looking_time = scaled_sample, 
         trial_type = case_when(
           stim_sequence == "BBBBBB" ~ "background", 
           stim_sequence == "BDBBBB" & trial_number == 2 ~ "deviant", 
           stim_sequence == "BBBDBB" & trial_number == 4 ~ "deviant", 
           stim_sequence == "BBBBBD" & trial_number == 6 ~ "deviant", 
           TRUE ~ "background"
         )) %>% 
  

m2_model <- lmer(log(trial_looking_time) ~ I((exp(1)**(-trial_number))) * trial_type * complexity + (1|sub_id), 
     data = best_fitting_scaled_cd)

model_model_summary <- summary(m2_model)$coefficients %>% as.data.frame() 
```

```{r}
saveRDS(behavioral_model_summary, here("behavior_fit/cached_res/complexity_behavior_lm.RDS"))

saveRDS(model_model_summary, here("behavior_fit/cached_res/complexity_model_lm.RDS"))
```



# New plot 

```{r}
library(ggthemes)
no_noise <- read_csv(here("behavior_fit/data/raw_data/no_noise.csv"), 
                     col_names = FALSE)
colnames(no_noise) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "n_samples")

no_learning <- read_csv(here("behavior_fit/data/raw_data/no_learning.csv"), 
                     col_names = FALSE)
colnames(no_learning) <- c("sub_id", "batch_id", "trial_num", "stim_sequence", "violation", "epsilon", "b_val", "d_val", "mu_prior", "v_prior", "alpha_prior", "beta_prior", "n_samples")

no_noise_scaled <- no_noise %>% 
  mutate(scaled_sample = (n_samples - scaling_df$intercept) / scaling_df$coef) %>% 
  mutate(trial_number = trial_num + 1, 
         trial_looking_time = scaled_sample, 
         stimuli_sequence = stim_sequence, 
         trial_type = case_when(
           stim_sequence == "BBBBBB" ~ "background", 
           stim_sequence == "BDBBBB" & trial_number == 2 ~ "deviant", 
           stim_sequence == "BBBDBB" & trial_number == 4 ~ "deviant", 
           stim_sequence == "BBBBBD" & trial_number == 6 ~ "deviant", 
           TRUE ~ "background"
         )) %>% 
  select(trial_number, trial_type, scaled_sample, stimuli_sequence) %>% 
  mutate(type = "No Noise")
  

no_learning_scaled <- no_learning %>% 
  mutate(scaled_sample = (n_samples - scaling_df$intercept) / scaling_df$coef) %>% 
  mutate(trial_number = trial_num + 1, 
         trial_looking_time = scaled_sample, 
         stimuli_sequence = stim_sequence, 
         trial_type = case_when(
           stim_sequence == "BBBBBB" ~ "background", 
           stim_sequence == "BDBBBB" & trial_number == 2 ~ "deviant", 
           stim_sequence == "BBBDBB" & trial_number == 4 ~ "deviant", 
           stim_sequence == "BBBBBD" & trial_number == 6 ~ "deviant", 
           TRUE ~ "background"
         )) %>% 
  select(trial_number, trial_type, scaled_sample, stimuli_sequence) %>% 
  mutate(type = "No Learning")


granch_scaled <- best_fitting_scaled_cd %>% 
  mutate(stimuli_sequence = stim_sequence) %>% 
  select(trial_number, trial_type, scaled_sample, stimuli_sequence) %>% 
  mutate(type = "GRANCH (adult) ")

test_plot_d <- test_d %>% 
  select(trial_number, trial_type, trial_looking_time, stimuli_sequence) %>% 
  rename(scaled_sample = trial_looking_time) %>% 
  mutate(type = "Adult behaviors")

bind_rows(no_learning_scaled, no_noise_scaled, granch_scaled, test_plot_d) %>% 
  ggplot(aes(x = trial_number, y = scaled_sample, color = trial_type, group = trial_type)) + 
  scale_color_manual(values = c("red", "blue")) + 
  stat_summary(geom = "line") + 
  stat_summary(fun.data = "mean_cl_boot") + 
  #scale_y_log10() + 
  #scale_x_log10() + 
  facet_wrap(~type, nrow = 1)+ 
  theme_few() 

```








# Reliability 

```{r}
library(splithalf)
split_half_reliability <- splithalf(test_d, outcome = "RT", 
          score = "average", 
          var.RT = "trial_looking_time", 
          var.participant = "subject")
```


```{r}
library(ggthemes)
fit_df <- best_fitting_scaled %>% 
  mutate(trial_number = trial_num + 1, 
         stimuli_sequence = stim_sequence) %>% 
  select(trial_number, stimuli_sequence, scaled_sample) %>% 
  rename(n = scaled_sample) %>% 
  mutate(type = "model")

b_df <- test_d %>% 
  select(trial_number, stimuli_sequence, trial_looking_time) %>% 
  rename(n = trial_looking_time) %>% 
  mutate(type = "behavior")

bind_rows(fit_df, b_df) %>% 
  ggplot(aes(x = trial_number, y = n, color = type)) + 
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = .2)) + 
  facet_wrap(~stimuli_sequence) + 
  theme_few()
```

