---
title: "distance metrics comparison"
author: "anjie &gal"
date: '2022-03-29'
output: html_document
---

Packages
```{r}
library(gplots)
library(factoextra)
library(tidyverse)
library(readr)
```

Heatmaps

```{r}

euc_dist <- read.csv('eucledian_distances.csv') 
cosine_dist <- read.csv('cosine_distances.csv')

euc_dist <- euc_dist[,-1] %>% as.matrix()
cosine_dist <- cosine_dist[,-1] %>% as.matrix() 
cosine_dist[cosine_dist < 0 ] = 0

# euc_dist <- (euc_dist - mean(euc_dist)) / sd(euc_dist)
# cosine_dist <-  (cosine_dist - mean(cosine_dist)) / sd(cosine_dist)


heatmap.2(euc_dist,dendrogram='none', Rowv=FALSE, Colv=FALSE,trace='none') 
heatmap.2(cosine_dist,dendrogram='none', Rowv=FALSE, Colv=FALSE,trace='none')

```

Clustering
```{r}

embeddings <- read.csv('all_embeddings.csv')
embeddings <- embeddings[,-1]

k2 <- kmeans(embeddings, centers = 2, nstart = 25)
fviz_cluster( k2,data = embeddings)

```


```{r}

embeddings_pca <- read.csv('all_embeddings_afterPCA.csv', header=FALSE)

plot_embeddings <- embeddings_pca %>% select(V1,V2) %>% 
  mutate(stim_name = euc_dist %>% colnames(), 
         animacy_type = case_when(str_detect(stim_name, "veggie") ~ "veggie",
                                     str_detect(stim_name, "animate") ~ "animate")) %>%
  filter(!(animacy_type == 'veggie' & str_detect(stim_name, '_left.png')))

ggplot(plot_embeddings, aes(x = V1, y = V2, color = animacy_type)) + geom_point() + xlab("PC1") + ylab("PC2") + theme_classic(base_size = 20)



```

# Plot distances
```{r}


all_names =  euc_dist %>% colnames() 
# assign row names
euc_dist = euc_dist %>% as.data.frame()
rownames(euc_dist) = all_names

animal_names = all_names[grep('animate',all_names)]
veggie_names = all_names[grep('veggie',all_names)] 



animal_poses = c('left', 'right')
veggie_poses = c('topleft', 'right')

```

# Animals
```{r}
distance_df_animals <- tibble(stim_name = vector(mode="character", length=length(animal_names)),
                              pose_dist = vector(mode="character", length=length(animal_names)),
                              animacy_dist = vector(mode="character", length=length(animal_names)), 
                              identity_dist = vector(mode="character", length=length(animal_names)))

idx = 0
for (animal in animal_names) {
   idx = idx + 1
   pose = sapply(animal_poses, grepl, animal)
   
   # find names of stim relevant for each violation
   pose_violation = str_replace(animal, names(which(pose)), names(which(!pose)))
   identity_violations = animal_names[grep(names(which(pose)), animal_names)] 
  # remove itself
  identity_violations = identity_violations[identity_violations != animal] 
  animacy_violations = veggie_names[grep(names(which(pose)), veggie_names)]

  # get distances
  pose_violation_dist = euc_dist[animal, pose_violation]
  identity_violation_dist = mean(euc_dist[animal, identity_violations]  %>% as.numeric())
  animacy_violations_dist =  mean(euc_dist[animal, animacy_violations] %>% as.numeric())
  
  distance_df_animals$stim_name[idx] = animal
  distance_df_animals$pose_dist[idx] = pose_violation_dist
  distance_df_animals$identity_dist[idx] = identity_violation_dist
  distance_df_animals$animacy_dist[idx] = animacy_violations_dist

}

distance_df_animals = pivot_longer(distance_df_animals, cols = c('pose_dist', 'identity_dist', 'animacy_dist'), names_to = 'violation_type')

ggplot(distance_df_animals, aes(x = violation_type, y = as.numeric(value))) + geom_jitter(width = 0.02) + geom_line(alpha = 0.2, aes(group = stim_name)) + theme_classic(base_size = 20) + xlab('Violation type') + ylab('embedding distance') + scale_x_discrete(labels = c('Animacy', 'Identity', 'Pose')) + ggtitle('Animals')

```

# Veggies
```{r}
# remove left veggies for now
veggie_names = veggie_names[!grepl('_left',veggie_names)] 

distance_df_veggies <- tibble(stim_name = vector(mode="character", length=length(veggie_names)),
                              pose_dist = vector(mode="character", length=length(veggie_names)),
                              animacy_dist = vector(mode="character", length=length(veggie_names)), 
                              identity_dist = vector(mode="character", length=length(veggie_names)))




idx = 0
for (veggie in veggie_names) {
   idx = idx + 1
   pose = sapply(veggie_poses, grepl, veggie)
   
   # find names of stim relevant for each violation
   pose_violation = str_replace(veggie, names(which(pose)), names(which(!pose)))
   identity_violations = veggie_names[grep(names(which(pose)), veggie_names)] 
  # remove itself
  identity_violations = identity_violations[identity_violations != veggie] 
  animacy_violations = animal_names[grep(animal_poses[which(pose)], animal_names)]

  # get distances
  pose_violation_dist = euc_dist[veggie, pose_violation]
  identity_violation_dist = mean(euc_dist[veggie, identity_violations]  %>% as.numeric())
  animacy_violations_dist =  mean(euc_dist[veggie, animacy_violations] %>% as.numeric())
  
  distance_df_veggies$stim_name[idx] = veggie
  distance_df_veggies$pose_dist[idx] = pose_violation_dist
  distance_df_veggies$identity_dist[idx] = identity_violation_dist
  distance_df_veggies$animacy_dist[idx] = animacy_violations_dist

}

distance_df_veggies = pivot_longer(distance_df_veggies, cols = c('pose_dist', 'identity_dist', 'animacy_dist'), names_to = 'violation_type')

ggplot(distance_df_veggies, aes(x = violation_type, y = as.numeric(value))) + geom_jitter(width = 0.02) + geom_line(alpha = 0.2, aes(group = stim_name)) + theme_classic(base_size = 20) + xlab('Violation type') + ylab('embedding distance') + scale_x_discrete(labels = c('Animacy', 'Identity', 'Pose')) + ggtitle('Veggies')

```