---
title: "granch_mini"
author: "anjie & gal"
date: "3/19/2022"
output: html_document
---
```{r}
library(here)
library(tictoc)
library(tidyverse)
library(matrixStats)
source(here("helper/granch_main_simulation_helper.R")) # this will import other helper functions 
source(here("helper/granch_sim_setup_helper.R")) # this will import functions that help with setting parameters 
```


```{r}

embedding_path <- here("embeddings/embedding_PCA.csv")

grid_mu_theta = get_embedding_range(embedding_path, step = 2)
grid_sig_sq = seq(0.01, 2, 0.2)
grid_y = get_embedding_range(embedding_path, step = 2)
grid_epsilon = seq(0.001, 1, 0.2)
hypothetical_obs_grid_n = 3 

# set model-related parameters 

mu_priors = c(0)
V_priors = c(1) 
alpha_priors = c(1) 
beta_priors = c(1) 
epsilons = c(0.01) 
mu_epsilon = c(1)
sd_epsilon = c(0.1)
world_EIGs = c(0.0000001) 
max_observation = 2000

model_params <- set_granch_params(mu_priors, V_priors, 
                alpha_priors, beta_priors, 
                epsilons, mu_epsilon, sd_epsilon,
                world_EIGs, max_observation)



# stims df will be something that taking in embeddings, but let's just ignore that for now
test_stim <- get_stimulus(1, 1, embedding_path)%>% pull()
stimuli_sequence <- tibble(V1 = rep(test_stim, 6), 
                   trial_number = seq(1, 6))

stims_df <- tibble(sequence_scheme = "BBBBBB", 
                   n_features = 1, 
                   on_features_n = 1 
                   ) %>% 
  mutate(stimuli_sequence = nest(stimuli_sequence, data = everything()))



full_params_df <- make_simulation_params(n_sim = 10,
                                        model_params, 
                                        stims_df)
# test_df <- full_params_df %>%
#   mutate(row_number = row_number()) %>% 
#   group_by(row_number) %>% 
#   nest()
# 
# params <- test_df[1, ]

```



# this is to set up the datarframe for testing with main function 
```{r}
test_df <- full_params_df %>%
  mutate(row_number = row_number()) %>% 
  group_by(row_number) %>% 
  nest()

params <- test_df[1, ]

```


```{r}
tic()
all_sims_res <- full_params_df %>%
  mutate(row_number = row_number()) %>% 
  group_by(row_number) %>% 
  nest() %>%
  mutate(results = map(data,
                       function(df) granch_main_simulation(params = df))) %>%
  unnest(cols = c(data, results))
toc()
```


```{r}
all_sims_res %>% 
  group_by(row_number, params_id, n_features, sequence_scheme, stimulus_idx) %>% 
  filter(!is.na(stimulus_idx)) %>% 
  summarise(sample_n = n()) %>% 
  ggplot(aes(x = stimulus_idx, y = sample_n)) + 
  stat_summary(position = position_dodge(width = .1),fun.data = "mean_cl_boot") + 
  facet_wrap(~sequence_scheme)
```



```{r}
get_stimulus <- function(n_stim,n_dim, embedding_path){
  em <- read_csv(embedding_path, col_names = FALSE)
  em[sample(nrow(em), n_stim), 1:n_dim]
}

get_stimulus(1, 1, embedding_path)
```



```{r}
get_embedding_range <- function(embedding_path, step = 2){
  em <- read_csv(embedding_path, col_names = FALSE)
  return(seq(mean(as.matrix(em)) - 3*sd(as.matrix(em)), 
             mean(as.matrix(em)) + 3*sd(as.matrix(em)), 
             step
             )) 
}
```




