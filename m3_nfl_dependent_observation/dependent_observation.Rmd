---
title: "dependent observation"
author: "anjie"
date: "7/22/2021"
output: html_document
---
```{r}
library(tidyverse)
library(here)
library(matrixStats)
library(profvis)

source(here("helper/get_eig_faster.R"))
source(here("helper/get_stimuli.R"))
source(here("helper/get_observation.R"))
source(here("helper/main_simulation_under_construction.r"))

num_features = 1
num_features_simple = 1
num_feature_complex = 6
trials_per_block = 3
deviant_positions = c(2)
feature_theta = 0.9
dissimilarity_ratio = 0.2
noise_parameter = 0.1

## grid approximation related 
grid_theta <- seq(0.1, 1, 0.2)
grid_epsilon <- seq(0.1, 1, 0.2)
alpha_prior = 1
beta_prior = 1
alpha_epsilon = 10 
beta_epsilon = 1

## eig related 
env_eig = 0.005
max_obs = 500

## experiment related 
subject_n = 10

simple_stimuli <- generate_creature_sequence(
  block_length = trials_per_block, 
  deviant_positions = deviant_positions,  # takes a vector, 
  total_feature = num_features, 
  feature_theta = feature_theta, 
  feature_number = num_features_simple, 
  dissimilar_ratio = dissimilarity_ratio)
```


```{r}
second_trial_same <- simple_stimuli
second_trial_diff <- second_trial_same
second_trial_diff$V1[2] <- FALSE
```

```{r}
same_sim <- main_simulations(subject_n = 50,
                second_trial_same, 
                noise_parameter = noise_parameter, 
                eig_from_world = 0.005,
                max_observation = 500, # should this be per trial or in total? currently per trial 
                grid_theta = grid_theta, 
                grid_epsilon = grid_epsilon, 
                alpha_prior = alpha_prior, 
                beta_prior = beta_prior,
                alpha_epsilon = alpha_epsilon, 
                beta_epsilon = beta_epsilon, 
                forced_exposure = TRUE,
                forced_sample = 5) %>% 
  mutate(type = "second_background")

diff_sim <- main_simulations(subject_n = 50,
                second_trial_diff, 
                noise_parameter = noise_parameter, 
                eig_from_world = 0.005,
                max_observation = 500, # should this be per trial or in total? currently per trial 
                grid_theta = grid_theta, 
                grid_epsilon = grid_epsilon, 
                alpha_prior = alpha_prior, 
                beta_prior = beta_prior,
                alpha_epsilon = alpha_epsilon, 
                beta_epsilon = beta_epsilon, 
                forced_exposure = TRUE,
                forced_sample = 5) %>% 
  mutate(type = "second_different")


```

```{r}

bind_rows(same_sim, diff_sim) %>% 
#same_sim %>% 
  group_by(subject_id, stimulus_idx,  type) %>% 
  drop_na() %>% 
  summarise(sample_n = n()) %>% 
  ungroup() %>% 
  ggplot(aes(x = stimulus_idx, y = sample_n, color = type)) + 
  geom_jitter(alpha = .3)+
  stat_summary(fun.data = "mean_cl_boot", position = position_dodge(width = 0.3)) 

```

