---
title: "Fitting model to data"
author: "anjie"
date: "8/26/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(here)
```

```{r}
replace_character <- function(string,position,replacement){   
  temp <- strsplit(string, "")[[1]];   
  temp[position] <- replacement;   
  paste0(temp, collapse = "") }


d <- read_csv(here("data/trimmed_RTdata.csv"))


temp_deviant_order <- d %>% 
  filter(trial_type == "deviant") %>% 
  select(subject, block_number, trial_number, trial_type) %>% 
  group_by(subject, block_number) %>% 
  mutate(
    index = row_number(),
    new_trial_type_index = case_when(
      index == 1 ~ "first_deviant", 
      index == 2 ~ "second_deviant"
    ), 
  ) %>% 
  ungroup() %>% 
  select(subject, block_number, trial_number, new_trial_type_index)


 temp_d <- d %>% 
   left_join(temp_deviant_order, by = c("subject", "block_number", "trial_number")) %>% 
   rowwise() %>% 
   mutate(
    new_trial_type_index = if_else(is.na(new_trial_type_index), 
                               "background", 
                               new_trial_type_index)
  )

 
d_lt_scheme <- d %>% 
   left_join(temp_d %>% filter(new_trial_type_index == "first_deviant") %>%  
               mutate(new_first_dev_position = trial_number) %>% 
               select(subject, block_number, new_first_dev_position), by = c("subject", "block_number")) %>% 
   left_join(temp_d %>% filter(new_trial_type_index == "second_deviant") %>%  
               mutate(new_second_dev_position = trial_number) %>% 
               select(subject, block_number, new_second_dev_position), by = c("subject", "block_number")
   ) %>% 
   select(-c(first_dev_position, second_dev_position)) %>% 
   rename(first_dev_position = new_first_dev_position, 
          second_dev_position = new_second_dev_position) %>% 
    group_by(subject, block_number) %>% 
  mutate(total_trial = max(trial_number),
         ) %>% 
  rowwise() %>% 
  mutate( temp_background = paste(rep("B", total_trial), collapse = ""), 
          sequence_scheme = case_when(
            block_deviant_number == 0 ~ temp_background, 
            block_deviant_number == 1 ~ replace_character(temp_background, first_dev_position, "D"), 
            block_deviant_number == 2 ~ replace_character(temp_background, c(first_dev_position, second_dev_position), "D"),
          )) 
```


2.get the parameters used in the original experiment and construct a training sequence 
feature missing: 
- different subjects using slightly different noise parameter & EIG_envr? 
- different background and deviant? (currently all one feature on and off)
- dependency between blocks? 
```{r}

# has requirmeent for the sparity of vector space or the dissimilar ratio won't work 
scheme_to_stimuli <- function(sequence_scheme, 
                              fixed_length_complexity = TRUE,
                              complexity, 
                              #similarity?, 
                              feature_space_n, 
                              simple_feature_n, complex_feature_n, 
                              dissimilar_ratio
){
  
  if (fixed_length_complexity){
    background_creature <- sample(c(rep(FALSE, 
                                        feature_space_n - ifelse(complexity == "complex", complex_feature_n, simple_feature_n)),                                     rep(TRUE, ifelse(complexity == "complex", complex_feature_n, simple_feature_n))))
    
    # make deviant creature
    # first figure out which location has TRUE
    deviant_creature <- background_creature
    
    feature_pos <- which(background_creature == TRUE)
    non_feature_pos <- which(background_creature == FALSE)
    total_feature_n <- length(feature_pos)
    feature_flip <- ceiling(total_feature_n * dissimilar_ratio)
    feature_change_pos <- sample(feature_pos, 
                               feature_flip, 
                               replace = FALSE)
    deviant_creature[feature_change_pos] <- !deviant_creature[feature_change_pos]
  
    # change non-feature to feature
    non_feature_change_pos <- sample(non_feature_pos, 
                                   ifelse(feature_flip > length(non_feature_pos), length(non_feature_pos), feature_flip), 
                                   replace = FALSE)
  
   deviant_creature[non_feature_change_pos] <-!deviant_creature[non_feature_change_pos]
  
   dissimilar_stimuli = creature
  
  
  }else{
    
    background_creature <- sample(c(rep(TRUE, ifelse(complexity == "complex", 
                                                     complex_feature_n, 
                                                     simple_feature_n))))
    # how to represent dissimilarity with ratio? currently just flipping 
    #FIXME: 
    deviant_creature <- as.logical(1-background_creature)
    
  }
  
    
  block_list <- strsplit(sequence_scheme, "")[[1]]
  
  background_sequence <- replicate(length(block_list), background_creature, simplify = FALSE)
  background_sequence[which(block_list == "D")] <- replicate(length(which(block_list == "D")), 
                                                             deviant_creature, simplify = FALSE)
  
  tidy_creature_sequence <- bind_rows(lapply(background_sequence,
                                             function(x) x %>% as_tibble_row(.name_repair = make.names))) 
  
  # renaming columns 
  rename_column <- function(x){paste0("V", x)}
  tidy_column_names <- lapply(1:length(background_creature), rename_column)
  colnames(tidy_creature_sequence) <- tidy_column_names
  tidy_creature_sequence <- tidy_creature_sequence %>% 
    mutate(trial_number = row_number())
  
  return(tidy_creature_sequence)
  

}



```

3.generate stimuli sequence with a fixed set of parameters 

currently assuming independence between blocks from the same participants 
```{r}
d_with_stimuli_sequence <- d_lt_scheme %>% 
  select(subject, block_number, sequence_scheme) %>% 
  distinct() %>% 
  rowwise() %>% 
  mutate(
    stimuli_sequence = nest(scheme_to_stimuli(sequence_scheme, fixed_length_complexity = FALSE, 
                                              complexity = "complex", 
                                              feature_space_n = 1, 
                                              simple_feature_n = 1, 
                                              complex_feature_n = 1, 
                                              dissimilar_ratio = 1), data = everything()), 
   
  ) %>% 
  ungroup() %>% 
  mutate(sim_id = row_number())
  
```

```{r}
source(here("helper/get_eig_faster.R"))
source(here("helper/get_stimuli.R"))
source(here("helper/get_observation.R"))
source(here("helper/main_simulation_under_construction.r"))
source(here("helper/params_helper_experiment.r"))
library(matrixStats)
grid_theta <- seq(0.1, 1, 0.2)
grid_epsilon <- seq(0.1, 1, 0.2)
grid_theta <- seq(0.1, 1, 0.2)
grid_epsilon <- seq(0.1, 1, 0.2)
alpha_epsilon = 1 
beta_epsilon = 1

d_for_linking <- d_with_stimuli_sequence %>% 
  select(sim_id, stimuli_sequence) %>% 
  mutate(noise_parameter = 0.001, 
         eig_from_world = 0.005, 
         max_observation = 500, 
         alpha_prior = 1, 
         beta_prior = 1)   # this eventually needs to be changed 

d_for_linking
```

```{r}
sim_res <- pmap_dfr(d_for_linking, 
     simulation_wrapper_for_linking_data
     )
```

# double check the length 
```{r}
sim_res %>% 
  group_by(sim_id, stimulus_idx) %>% 
  summarise(
    sample_n = n()
  ) %>% 
  filter(!is.na(stimulus_idx)) %>% 
  group_by(sim_id) %>% 
  mutate(trial_num = max(stimulus_idx)) %>% 
  ungroup() %>% 
  distinct(sim_id, trial_num) %>% 
  left_join(d_with_stimuli_sequence, by = "sim_id") %>% 
  rowwise() %>% 
  mutate(origianl_seq_length = length(str_split(sequence_scheme, "")[[1]])) %>% 
  filter(origianl_seq_length != trial_num)
```
```{r}
d_with_stimuli_sequence
d_res_final <- d_lt_scheme %>% 
  ungroup() %>% 
  select(subject, block_number, block_type, trial_number, trial_type, rt
         ) %>% 
  left_join(d_with_stimuli_sequence, by = c("subject", "block_number")) %>% 
  left_join(sim_res %>% group_by(sim_id, stimulus_idx) %>% 
              summarise(
              sample_n = n()
              ) %>% 
              filter(!is.na(stimulus_idx)) %>% 
              rename(trial_number = stimulus_idx), 
            by = c("sim_id", "trial_number"))
  
  
```


# plotting 





```{r}
d_res_final %>% 
  ggplot(aes(x = trial_number, y = sample_n, color = trial_type)) + 
  stat_summary(fun.data = "mean_cl_boot") + 
  theme_classic() 
```

```{r}
d_res_final %>% 
  group_by(
    trial_number, 
    block_type, 
    trial_type
  ) %>% 
  summarise(
    mean_lt = mean(rt+500), 
    mean_sample = mean(sample_n)
  ) %>% 
  ggplot(aes(x = log(mean_lt), y = mean_sample)) + 
   geom_point() + 
  geom_smooth(method = "lm") + 
  #facet_wrap(~block_type)+ 
  theme_classic()
```
```{r}
d_res_summary = d_res_final %>% 
  group_by(
    trial_number, 
    block_type, 
    trial_type
  ) %>% 
  summarise(
    log_rt = log(rt+500),
    mean_lt = mean(rt+500), 
    mean_log_lt = mean(log_rt),
    mean_sample = mean(sample_n)
  ) 

cor.test(d_res_summary$mean_lt, d_res_summary$mean_sample, method=c("pearson"))
cor.test(d_res_summary$mean_log_lt, d_res_summary$mean_sample, method=c("pearson"))

```






